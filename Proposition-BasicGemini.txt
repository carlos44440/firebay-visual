import streamlit as st
from streamlit.components.v1 import html
import pandas as pd
from datetime import datetime, timedelta

# --- CONFIGURACI√ìN DE P√ÅGINA ---
# Usa el tema oscuro, ideal para paneles de monitoreo de alerta
st.set_page_config(
    page_title="FireBay: Monitoreo de Incendios Ays√©n",
    page_icon="üî•",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Colores y estilos (para darle un toque profesional)
# Usaremos clases personalizadas en Markdown para los indicadores de riesgo
st.markdown("""
    <style>
    /* Fuente Inter para mejor legibilidad */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    
    body {
        font-family: 'Inter', sans-serif;
    }
    
    .st-emotion-cache-1cypcdb { /* Contenedor principal para el t√≠tulo */
        padding-top: 1rem;
    }
    
    .risk-card {
        border-radius: 10px;
        padding: 15px;
        color: white;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
    }
    .risk-card:hover {
        transform: translateY(-5px);
    }
    .risk-low { background-color: #28a745; } /* Verde */
    .risk-moderate { background-color: #ffc107; color: #333 !important; } /* Amarillo */
    .risk-high { background-color: #fd7e14; } /* Naranja */
    .risk-extreme { background-color: #dc3545; } /* Rojo */
    .kpi-label { font-size: 14px; margin-bottom: 5px; opacity: 0.8; }
    .kpi-value { font-size: 32px; font-weight: 800; }
    </style>
""", unsafe_allow_html=True)


# --- FUNCIONES DE VISUALIZACI√ìN ---

def display_windy_map(lat, lon, zoom, overlay, height=600):
    """Genera y muestra el iframe del mapa de Windy."""
    st.subheader("Mapa Interactivo de Condiciones Clim√°ticas (Windy)")
    
    # 1. Construir la URL completa
    windy_url = (
        "https://embed.windy.com/embed2.html?"
        f"lat={lat}&lon={lon}&zoom={zoom}&overlay={overlay}"
        "&menu=&message=true&marker=&calendar=&pressure=&type=map&location=coordinates"
    )
    
    # 2. Crear el c√≥digo HTML del IFRAME
    iframe_code = f"""
    <iframe 
        width="100%" 
        height="{height}" 
        src="{windy_url}" 
        frameborder="0" 
        allowfullscreen="true"
        style="border-radius: 10px;">
    </iframe>
    """
    # 3. Mostrar el mapa usando el componente HTML de Streamlit
    html(iframe_code, height=height + 20)
    st.caption(f"üìç Coordenadas: {lat}, {lon} | Capa Activa: {overlay}")

def display_kpi_card(title, value, unit, risk_level):
    """Muestra una tarjeta KPI con estilo de riesgo."""
    
    # Asigna la clase CSS seg√∫n el nivel de riesgo
    class_map = {
        "BAJO": "risk-low",
        "MODERADO": "risk-moderate",
        "ALTO": "risk-high",
        "EXTREMO": "risk-extreme"
    }
    css_class = class_map.get(risk_level, "risk-low")
    
    st.markdown(f"""
        <div class="risk-card {css_class}">
            <div class="kpi-label">{title} ({risk_level})</div>
            <div class="kpi-value">{value} {unit}</div>
        </div>
    """, unsafe_allow_html=True)


# --- BARRA LATERAL (Filtros y Navegaci√≥n) ---

st.sidebar.header("FireBay | Bah√≠a Exploradores")
st.sidebar.markdown("---")

# 1. Filtros de Fecha/Tiempo
st.sidebar.subheader("üìÖ Rango de Monitoreo")
forecast_date = st.sidebar.date_input(
    "Fecha del Pron√≥stico", 
    datetime.now().date() + timedelta(days=1)
)

st.sidebar.selectbox(
    "Modelo de Pron√≥stico",
    ["GFS (Global)", "ICON-EU (Europa/Placeholder)"],
    index=0
)

st.sidebar.markdown("---")
st.sidebar.subheader("üì° Capas de Datos")
selected_overlay = st.sidebar.selectbox(
    "Seleccionar Capa de Windy",
    ["Viento (wind)", "Lluvia (rain)", "Temperatura (temp)", "Riesgo de Incendio (fire danger)"],
    index=3,
    format_func=lambda x: x.split('(')[0].strip()
)
# Extrae el c√≥digo de la capa para el URL de Windy
overlay_code = selected_overlay.split('(')[1].replace(')', '')


# --- √ÅREA PRINCIPAL ---

st.header("Dashboard Operacional FireBay")
st.markdown("Monitoreo de riesgo de incendio en la Regi√≥n de Ays√©n, Bah√≠a Exploradores, Chile.")


# --- 1. Indicadores Clave de Riesgo (KPIs) ---
st.subheader("üî• √çndice de Peligro (FWI & Meteorolog√≠a)")

col1, col2, col3, col4 = st.columns(4)

# Estos son valores PLACEHOLDER, que se llenar√°n con los datos reales del FWI de Copernicus
with col1:
    display_kpi_card("FWI (√çndice Incendio)", 45.3, "", "EXTREMO") # Valor de ejemplo FWI > 38
    
with col2:
    # Placeholder para datos de la API Windy de un punto
    display_kpi_card("Humedad Relativa M√≠nima", 22.5, "%", "ALTO") 

with col3:
    display_kpi_card("Velocidad M√°xima del Viento", 35, "km/h", "ALTO") 

with col4:
    display_kpi_card("Precipitaci√≥n Acumulada (3h)", 0.0, "mm", "EXTREMO") 


st.markdown("---")

# --- 2. Mapa Interactivo de Windy ---
# Variables de configuraci√≥n del mapa (Bah√≠a Exploradores, Ays√©n)
lat = -46.31050588037077
lon = -73.42610705801674
zoom = 10 

display_windy_map(lat, lon, zoom, overlay_code)


st.markdown("---")


# --- 3. An√°lisis Satelital y Tendencias Hist√≥ricas (Futuras Implementaciones) ---
st.subheader("üõ∞Ô∏è An√°lisis de Datos y Tendencias")

col_left, col_right = st.columns(2)

with col_left:
    st.info("üí° **Funcionalidad Pendiente:** Gr√°fico de Tendencia Meteorol√≥gica y FWI (Se llenar√° con datos de la Point Forecast API de Windy o FWI calculado).")
    
    # Placeholder para la gr√°fica
    mock_data = {
        'Tiempo': pd.to_datetime([datetime.now() + timedelta(hours=i*3) for i in range(8)]),
        'Temperatura (¬∞C)': [15, 17, 19, 21, 18, 16, 14, 13],
        'Humedad (%)': [75, 68, 55, 45, 50, 60, 70, 78],
        'FWI (√çndice)': [10, 15, 25, 35, 30, 20, 15, 12]
    }
    df_mock = pd.DataFrame(mock_data).set_index('Tiempo')
    
    st.line_chart(df_mock[['Temperatura (¬∞C)', 'Humedad (%)']])
    st.area_chart(df_mock['FWI (√çndice)'])


with col_right:
    st.warning("‚ö†Ô∏è **Funcionalidad Cr√≠tica:** Visualizaci√≥n de Estr√©s de Vegetaci√≥n (NDVI) y Detecci√≥n de Focos de Calor (Copernicus/MODIS).")
    
    st.metric(
        label="√Årea con Estr√©s de Vegetaci√≥n (NDVI < 0.2)",
        value="1,250 ha",
        delta="‚ñ≥ 15% (√∫ltimas 24h)",
        delta_color="inverse" # Indica que el aumento es peligroso
    )
    
    st.button("üîç Ejecutar An√°lisis Satelital de √öltima Hora", type="primary")

st.markdown("---")
st.caption("FireBay v0.1 | Desarrollado para la prevenci√≥n en Bah√≠a Exploradores. Fuente: Windy Embed, Datos PLACEHOLDER.")